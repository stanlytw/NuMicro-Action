name: VSCode building

on:
  workflow_dispatch:
    inputs:
      git-address:
        description: 'git-address'
        required: true
        default: 'https://github.com/OpenNuvoton/M2L31BSP.git'
      branches-tags:
        description: 'branches-tags'
        required: true
        default: 'master'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - uses: actions/checkout@v2
      - name: Clone source code
        shell: bash
        run: |
          git clone ${{github.event.inputs.git-address}} ./bsp_repo

      - name: Install jq on Windows
        if: matrix.os == 'windows-latest'
        run: choco install jq

      - name: Install tools
        uses: ARM-software/cmsis-actions/vcpkg@v1
        with:
          config: ".github/workflows/vcpkg-configuration.json"

      - name: Activate Arm tool license
        uses: ARM-software/cmsis-actions/armlm@v1     

      - name: Prepare Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libncurses5

      - name: Activate & Build each csolution
        shell: bash
        run: |
          mapfile -t solutions < <(find ./bsp_repo/SampleCode -name '*.csolution.yml')

          set +e
          for sol in "${solutions[@]}"; do
            proj_dir=$(dirname "$sol")
            proj=$(basename "$sol")
            cd "$proj_dir"
            echo "current -> $(pwd)"

            echo "Building: $sol"

            vcpkg activate --downloads-root="${{ github.workspace }}/.vcpkg/downloads" --json=env.json

            echo "Preserving vcpkg PATH ..."
            jq '.paths.PATH[]' env.json | tr -d '"' >> "$GITHUB_PATH"
      
            echo "Preserving vcpkg ENV ..."
            jq -r '.tools | to_entries[] | "\(.key)=\(.value)"' env.json >> "$GITHUB_ENV"

            cbuild "$proj" --update-rte --packs

            cbuild "$proj" --update-rte --clean

            vcpkg deactivate

            cd - > /dev/null

          done
          set -e

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.os }}
          path: |
            **/SampleCode/**/*.bin
